# 分布式系统

### 四大基础理论

- 拜占庭将军问题
- CAP 理论
- ACID 理论
- BASE 理论

### 八大分布式协议和算法

- Paxos 算法
- Raft 算法
- 一致性 Hash 算法
- Gossip 协议算法
- Quorum NWR 算法
- FBFT 算法
- POW 算法
- ZAB 协议



### zookeeper有哪些特点

- 顺序一致性：来自客户端的更新将按照发送的顺序被写入到zk
- 原子性：更新操作要么成功要么失败，没有中间状态
- 单系统快照：客户端将看到服务的相同视图，而不管它连接到的服务器。
- 可靠性：一旦应用更新，数据将被持久化，直到数据被再次更新，对于该保证有两个推论：1、如果客户端得到了成功的返回码，说明写入成功，数据被持久化，如果出现了通信错误，超时等一些故障，客户端将不知道更新是否已应用。我们采取措施尽量减少失败，但唯一的保证是只有成功的返回码。 （这在Paxos中称为单调性条件。）2、如果客户端已经读取到了数据或者写入成功了数据，都不会因为zk的失败而导致回滚；
- 及时性：在一段时间后，客户端将看到最新的系统更新，在此期间客户端将看到这种变更

### zookeeper缺点

1. zookeeper master就只能照顾一个机房，其他机房运行的业务模块由于没有master都只能停掉，对网络抖动非常敏感。
2. 选举过程速度很慢且zk选举期间无法对外提供服务。
3. zk的性能有限:典型的zookeeper的tps大概是一万多，无法覆盖系统内部每天动辄几十亿次的调用。因此每次请求都去zookeeper获取业务系统master信息是不可能的。因此zookeeper的client必须自己缓存业务系统的master地址。
4. zk本身的权限控制非常薄弱.
5. **羊群效应**: 所有的客户端都尝试对一个临时节点去加锁，当一个锁被占有的时候，其他的客户端都会监听这个临时节点。一旦锁被释放，Zookeeper反向通知添加监听的客户端，然后大量的客户端都尝试去对同一个临时节点创建锁，最后也只有一个客户端能获得锁，但是大量的请求造成了很大的网络开销，加重了网络的负载，影响Zookeeper的性能.
6.  非高可用：极端情况下zk会丢弃一些请求:机房之间连接出现故障。
7. 读写不一致问题

**解决方法**:是获取锁时创建一个临时顺序节点，顺序最小的那个才能获取到锁，之后尝试加锁的客户端就监听自己的上一个顺序节点，当上一个顺序节点释放锁之后，自己尝试加锁，其余的客户端都对上一个临时顺序节点监听，不会一窝蜂的去尝试给同一个节点加锁导致羊群效应。

1. zk进行读取操作，读取到的数据可能是过期的旧数据，不是最新的数据。如果一个zk集群有10000台节点，当进行写入的时候，如果已经有6K个节点写入成功，zk就认为本次写请求成功。但是这时候如果一个客户端读取的刚好是另外4K个节点的数据，那么读取到的就是旧的过期数据。

### zk中过半原则

所谓“过半”是指大于集群机器数量的一半，即大于或等于（n/2+1），此处的“集群机器数量”不包括observer角色节点。leader广播一个事务消息后，当收到半数以上的ack信息时，就认为集群中所有节点都收到了消息，然后leader就不需要再等待剩余节点的ack，直接广播commit消息，提交事务。半数选举导致zookeeper通常由2n+1台server组成。

1. **zookeeper的两阶段提交**：zookeeper中，客户端会随机连接到 zookeeper 集群中的一个节点，如果是读请求，就直接从当前节点中读取数据。如果是写请求，那么请求会被转发给 leader 提交事务，然后 leader 会广播事务，只要有超过半数节点写入成功，那么写请求就会被提交。
   1. Leader将写请求转化为一个Proposal（提议），将其分发给集群中的所有Follower节点。
   2. Leader等待所有的Follower节点的反馈，一旦超过半数Follower进行了正确的反馈，那么Leader就会再次向所有的Follower节点发送Commit消息，要求各个Follower节点对前面的一个Proposal节点进行提交。
   3. leader节点将最新数据同步给Observer节点。
   4. 返回给客户端执行的结果。

### zk如何实现读写真正的强一致性

可能问到cap中zk是保证cp。那为什么一致性，还会有读到旧数据的问题(性能)。zookeeper既然不是强一致性的，那我们如何能保证两个客户端读到的数据是一致性的呢，那就是sync方法，zookeeper原生客户端API和Curator客户端都提供了该sync()方法，调用sync()方法之后，zookeeper集群会保证集群所有节点数据都是一致性的，此时客户端再去任意节点读取数据，都能读取最新的数据。

### zk和redis锁如何选择



### 时间轮是什么



### reference

[浅析redis与zookeeper构建分布式锁的异同](https://juejin.cn/post/6973235533996621861)

